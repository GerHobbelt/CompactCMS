(function(){var h="2.1.2",q="tinyautosave",r=false,y=false,A=false,d={"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"},F={"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"},k=[],B={},j={},g="TinyAutoSave_Test_",p=null,a={dataKey:"TinyAutoSave",cookieFilter:null,saveDelegate:null,saveFinalDelegate:null,restoreDelegate:null,disposeDelegate:null,restoreImage:"",progressImage:"progress.gif",intervalSeconds:60,retentionMinutes:20,minSaveLength:50,askBeforeUnload:false,canRestore:false,busy:false,timer:null};try{localStorage.setItem(g,"OK");if(localStorage.getItem(g)==="OK"){localStorage.removeItem(g);r=true}}catch(x){try{sessionStorage.setItem(g,"OK");if(sessionStorage.getItem(g)==="OK"){sessionStorage.removeItem(g);y=true}}catch(x){A=tinymce.isIE}}tinymce.PluginManager.requireLangPack(q);tinymce.create("tinymce.plugins.TinyAutoSavePlugin",{editor:null,url:"",key:"",onPreSave:null,onPostSave:null,onSaveError:null,onPreRestore:null,onPostRestore:null,onRestoreError:null,showSaveProgress:true,progressDisplayTime:1200,init:function(G,H){var I=this,K=tinymce.is,M=tinymce.resolve,J,e,L;if(A){if(!p){p=G.getElement()}p.style.behavior="url('#default#userData')"}I.editor=G;I.id=G.id;I.url=H;I.key=G.getParam(q+"_key",G.id);J=D(I);J.restoreImage=H+"/images/restore."+(tinymce.isIE6?"gif":"png");I.setProgressImage(H+"/images/"+a.progressImage);J.intervalSeconds=Math.max(1,parseInt(G.getParam(q+"_interval_seconds",null)||G.getParam(q+"_interval",J.intervalSeconds)));J.retentionMinutes=Math.max(1,parseInt(G.getParam(q+"_retention_minutes",null)||G.getParam(q+"_retention",J.retentionMinutes)));J.minSaveLength=Math.max(1,parseInt(G.getParam(q+"_minlength",J.minSaveLength)));I.showSaveProgress=G.getParam(q+"_showsaveprogress",I.showSaveProgress);J.askBeforeUnload=G.getParam(q+"_ask_beforeunload",J.askBeforeUnload);J.canRestore=I.hasSavedContent();J.saveDelegate=n(I,v);J.saveFinalDelegate=n(I,l);J.restoreDelegate=n(I,u);G.addCommand("mceTinyAutoSave",J.saveDelegate);G.addCommand("mceTinyAutoSaveRestore",J.restoreDelegate);G.addButton(q,{title:q+".restore_content",cmd:"mceTinyAutoSaveRestore",image:J.restoreImage});J.timer=window.setInterval(J.saveDelegate,J.intervalSeconds*1000);tinymce.dom.Event.add(window,"unload",J.saveFinalDelegate);G.onRemove.add(J.saveFinalDelegate);G.onPostRender.add(function(O,N){O.controlManager.setDisabled(q,!J.canRestore)});e=G.getParam(q+"_oninit",null);if(K(e,"string")){L=M(e);if(K(L,"function")){L.apply(I)}}if(J.askBeforeUnload){tinymce.dom.Event.add(window,"unload",tinymce.plugins.AutoSavePlugin._beforeUnloadHandler)}},getInfo:function(){return{longname:"TinyAutoSave",author:"Speednet",authorurl:"http://www.speednet.biz/",infourl:"http://tinyautosave.googlecode.com/",version:h}},clear:function(){var G=this,e=G.editor,H=o(G);if(r){localStorage.removeItem(H.dataKey)}else{if(y){sessionStorage.removeItem(H.dataKey)}else{if(A){t(G)}else{tinymce.util.Cookie.remove(H.dataKey)}}}H.canRestore=false;e.controlManager.setDisabled(q,G)},hasSavedContent:function(){var I=this,J=o(I),G=new Date(),K,H;try{if(r||y){K=((r?localStorage.getItem(J.dataKey):sessionStorage.getItem(J.dataKey))||"").toString(),H=K.indexOf(",");if((H>8)&&(H<K.length-1)){if((new Date(K.slice(0,H)))>G){return true}if(r){localStorage.removeItem(J.dataKey)}else{sessionStorage.removeItem(J.dataKey)}}return false}else{if(A){return((m(I)||"").length>0)}}return((tinymce.util.Cookie.get(J.dataKey)||"").length>0)}catch(L){return false}},setProgressImage:function(e){if(tinymce.is(e,"string")){b(o(this).progressImage=e)}},"static":{_beforeUnloadHandler:function(){var e;tinymce.each(tinyMCE.editors,function(G){if(G.getParam("fullscreen_is_enabled")){return}if(G.isDirty()){e=G.getLang("autosave.unload_msg");return false}});return e}}});function C(){var e=this,G=o(e);if(G.timer){window.clearInterval(G.timer)}tinymce.dom.Event.remove(window,"unload",G.saveFinalDelegate);if(G.askBeforeUnload){tinymce.dom.Event.remove(window,"unload",tinymce.plugins.AutoSavePlugin._beforeUnloadHandler)}e.editor.onRemove.remove(G.saveFinalDelegate);f(e)}function c(I){if(!I){return true}var H,G,e=tinymce.is;if(e(I,"string")){H=j[I];if(H){G=H[I]}else{j[I]=G=tinymce.resolve(I)}}else{if(e(I,"function")){G=I}else{return true}}return G.apply(this)}function l(){var e=o(this);e.saveDelegate();e.disposeDelegate()}function v(){var R=this,K=R.editor,S=o(R),J=tinymce.is,Q=false,G=new Date(),M,H,O,N,P,I;if((K)&&(!S.busy)){S.busy=true;M=K.getContent();if(J(M,"string")&&(M.length>=S.minSaveLength)){if(!c.call(R,R.onPreSave)){S.busy=false;return false}H=new Date(G.getTime()+(S.retentionMinutes*60*1000));try{if(r){localStorage.setItem(S.dataKey,H.toString()+","+i(M))}else{if(y){sessionStorage.setItem(S.dataKey,H.toString()+","+i(M))}else{if(A){s(R,M,H)}else{O=S.dataKey+"=";N="; expires="+H.toUTCString();document.cookie=O+z(M).slice(0,4096-O.length-N.length)+N}}}Q=true}catch(L){c.call(R,R.onSaveError)}if(Q){P=K.controlManager;S.canRestore=true;P.setDisabled(q,false);if(R.showSaveProgress){N=tinymce.DOM.get(P.get(q).id);if(N){I=S.restoreImage;N.firstChild.src=S.progressImage;window.setTimeout(function(){N.firstChild.src=I},Math.min(R.progressDisplayTime,S.intervalSeconds*1000-100))}}c.call(R,R.onPostSave)}}S.busy=false}return Q}function u(){var J=this,H=J.editor,K=o(J),M=null,L=tinymce.is,I,G;if((H)&&(K.canRestore)&&(!K.busy)){K.busy=true;if(!c.call(J,J.onPreRestore)){K.busy=false;return}try{if(r||y){M=((r?localStorage.getItem(K.dataKey):sessionStorage.getItem(K.dataKey))||"").toString();I=M.indexOf(",");if(I==-1){M=null}else{M=E(M.slice(I+1,M.length))}}else{if(A){M=m(J)}else{G=K.cookieFilter.exec(document.cookie);if(G){M=w(G[1])}}}if(!L(M,"string")){H.windowManager.alert(q+".no_content")}else{if(H.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length===0){H.setContent(M);c.call(J,J.onPostRestore)}else{H.windowManager.confirm(q+".warning_message",function(e){if(e){H.setContent(M);c.call(J,J.onPostRestore)}K.busy=false},J)}}}catch(N){c.call(J,J.onRestoreError)}K.busy=false}}function s(e,H,G){p.setAttribute(o(e).dataKey,H);p.expires=G.toUTCString();p.save("TinyMCE")}function m(e){p.load("TinyMCE");return p.getAttribute(o(e).dataKey)}function t(e){p.removeAttribute(o(e).dataKey)}function z(e){return e.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(G){if(G.length>1){return("%0"+G.charAt(0)+G.length.toString()+"%")}return d[G]})}function w(e){return e.replace(/%[1-5]|%0(.)(\d+)%/g,function(L,G,K){var I,J,H;if(L.length==2){return F[L]}for(I=[],J=0,H=parseInt(K);J<H;J++){I.push(G)}return I.join("")})}function i(e){return e.replace(/,/g,"&#44;")}function E(e){return e.replace(/&#44;/g,",")}function b(e){var G=k.length;k[G]=new Image();k[G].src=e}function n(e,G){return function(){return G.apply(e)}}function D(H){var e=H.key,G=B[e];if(!G){G=B[e]=tinymce.extend({},a,{dataKey:a.dataKey+e,saveDelegate:n(H,v),saveFinalDelegate:n(H,l),restoreDelegate:n(H,u),disposeDelegate:n(H,C),cookieFilter:new RegExp("(?:^|;\\s*)"+a.dataKey+e+"=([^;]*)(?:;|$)","i")})}return G}function o(e){return B[e.key]}function f(e){delete B[e.key]}tinymce.PluginManager.add(q,tinymce.plugins.TinyAutoSavePlugin)})();